<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.edu.review">
	
	<!-- 검색 조건 -->
	<sql id="searchMySQL">
		<if test="searchType != null">
			<if test="searchType == 's'.toString()">
				AND review_subject LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'c'.toString()">
				AND review_content LIKE CONCAT('%', #{keyword}, '%')
			</if>
			<if test="searchType == 'u'.toString()">
				AND userID LIKE CONCAT('%', #{keyword}, '%')
			</if>
		</if>
	</sql>	
	
	<!-- 리뷰 목록 가져오기 -->
	<select id = "reviewList" parameterType="com.edu.common.util.SearchCriteria"  resultType = "com.edu.review.dto.ReviewDTO">
		<![CDATA[
			SELECT *
			FROM (
			SELECT review_bno, review_subject, review_content, userID, product_type, product_name, review_date, review_star, ROW_NUMBER() OVER(ORDER BY review_bno DESC) AS rNUM
			FROM t_review WHERE 1=1
			]]>
			<include refid="searchMySQL"/>
			<![CDATA[
			) brd
			WHERE rNUM BETWEEN (#{perPageNum} * #{page} - 11) and (#{perPageNum} * #{page})
			ORDER BY review_bno DESC;
		]]>
	</select>

	<!-- 전체 페이지 가져오기 -->
	<select id = "reviewListTotalCount"  parameterType="com.edu.common.util.SearchCriteria"  resultType = "Integer">
		<![CDATA[
			select count(*) from t_review where 1=1;
		]]>
	</select>
	
	<!-- 리뷰 전체 리스트 가져오기 -->
	<select id = "totalList" resultType = "com.edu.review.dto.ReviewDTO">
		<![CDATA[
			select * from t_review order by review_bno desc;
		]]>
	</select>
	
	<!-- 리뷰 등록하기 -->
	<select id = "reviewRegister" parameterType = "com.edu.review.dto.ReviewDTO">
		<![CDATA[ 
		insert into t_review(review_bno, userID, review_subject, review_content, product_type, product_name, review_date, review_star)
		select ifnull(max(review_bno), 0) +1, #{userID}, #{review_subject}, #{review_content}, #{product_type}, #{product_name}, now(), #{review_star} from t_review
		]]>
	</select>
			
	<select id="productList" resultType="com.edu.review.dto.ReviewDTO" parameterType = "com.edu.product.dto.ProductDTO">
		<![CDATA[
		SELECT r.review_bno, r.userID, r.review_subject, r.review_content, r.review_date, r.review_star
		FROM t_product p , t_review r
		]]>
	</select>
	
	<select id="searchname" resultType="com.edu.product.dto.ProductDTO" parameterType = "String">
		select product_name
		from t_product
		where product_type = #{product_type}
	</select>
	
	<select id = "detail" parameterType = "int" resultType = "com.edu.review.dto.ReviewDTO">
		<![CDATA[
			select * from t_review where review_bno = #{review_bno};
		]]>
	</select>
	
	
	
	
</mapper>






